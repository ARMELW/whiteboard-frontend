# Thumbnail Display and Auto-Save Fix

## Issues Fixed

### Issue 1: Scene Thumbnail Not Showing Resized Image Correctly
**Problem**: When an image was resized in the canvas editor, the thumbnail in the scene panel showed the image stretched to fill the entire thumbnail container instead of maintaining the actual scene proportions.

**Root Cause**: The thumbnail image element was using `object-cover` CSS class, which scales the image to fill the container and may crop it. This caused resized elements to appear larger than their actual size in the scene.

**Solution**: Changed from `object-cover` to `object-contain` in `ScenePanel.tsx`. This preserves the aspect ratio and shows the thumbnail exactly as generated by the thumbnail generator.

### Issue 2: Auto-Save Not Triggering on Layer Property Changes
**Problem**: The auto-save functionality wasn't saving changes when layer properties (position, scale, rotation, opacity, etc.) were modified.

**Root Cause**: The `useEffect` hook in `LayerEditor.tsx` only monitored specific top-level scene properties (`layers`, `sceneCameras`, `backgroundImage`). When individual layer properties changed within the layers array, the array reference remained the same, so the effect didn't trigger.

**Solution**: Changed the dependency array to monitor the entire `editedScene` object. This ensures auto-save triggers for ANY scene change, with a 2-second debounce to prevent excessive saves.

## Files Changed

1. **src/components/organisms/ScenePanel.tsx**
   - Line 175, 182: Changed `object-cover` to `object-contain`

2. **src/components/organisms/LayerEditor.tsx**
   - Line 122: Changed dependency array from `[editedScene.layers, editedScene.sceneCameras, editedScene.backgroundImage, scene?.id, handleSave]` to `[editedScene, scene?.id]`
   - Added explanatory comments and eslint-disable for intentional missing dependency

## Testing Instructions

### Test 1: Thumbnail Display Fix

1. Start the application: `npm run dev`
2. Create or open a scene
3. Add an image to the scene
4. Resize the image to be significantly smaller (e.g., 50% of original size)
5. Save the scene
6. Check the scene thumbnail in the sidebar panel
7. **Expected Result**: The thumbnail should show the image at the resized dimensions, not stretched to fill the thumbnail
8. **Verification**: The image in the thumbnail should have the same relative size as in the canvas editor

### Test 2: Auto-Save Functionality

1. Start the application: `npm run dev`
2. Create or open a scene
3. Add an image to the scene
4. Perform various edits without manually saving:
   - Move the image (drag it)
   - Resize the image (use transformer handles)
   - Rotate the image
   - Change opacity (if available in UI)
   - Add another layer (text, shape, or image)
5. Wait 2-3 seconds after each change
6. Refresh the page or navigate away and back
7. **Expected Result**: All changes should be persisted automatically
8. **Verification**: After refresh, all edits should still be present

### Test 3: Combined Functionality

1. Create a scene with multiple layers (images, text, shapes)
2. Resize some elements to be smaller/larger
3. Reposition elements
4. Wait for auto-save (2 seconds)
5. Check the scene thumbnail in the sidebar
6. Refresh the page
7. **Expected Result**: 
   - Thumbnail accurately reflects the scene layout with correct element sizes
   - All changes are persisted after refresh

## Technical Details

### Thumbnail Generation Process

1. `generateSceneThumbnail()` in `sceneThumbnail.ts` calls `exportSceneImage()`
2. `exportSceneImage()` in `sceneExporter.ts` renders all layers on a canvas at camera resolution
3. For image layers, it uses `img.width * layer.scale` and `img.height * layer.scale` to calculate rendered dimensions
4. The canvas is exported as a data URL and resized to thumbnail dimensions (320x180) with aspect ratio maintained
5. The thumbnail is displayed in the UI with `object-contain` to preserve its aspect ratio

### Auto-Save Mechanism

1. `LayerEditor.tsx` maintains an `editedScene` state that tracks all changes
2. A `useEffect` hook monitors `editedScene` for changes
3. When a change is detected, it starts a 2-second debounce timer
4. If another change occurs within 2 seconds, the timer resets
5. After 2 seconds of inactivity, `handleSave()` is called to persist changes
6. `handleSave()` calls `useScenesActions().updateScene()` which also triggers thumbnail regeneration

## Performance Considerations

- **Auto-Save Debounce**: The 2-second debounce prevents excessive API calls during rapid editing
- **Thumbnail Generation**: Thumbnails are regenerated after each save, which includes rendering all layers
- **Effect Optimization**: Removed `handleSave` from the dependency array to prevent double-triggering

## Potential Improvements (Future Work)

1. **Selective Auto-Save**: Only save changed properties instead of the entire scene
2. **Thumbnail Caching**: Cache thumbnails and only regenerate when scene visuals change
3. **Deep Comparison**: Use a deep comparison library to only trigger saves when meaningful changes occur
4. **Visual Feedback**: Add a "Saving..." indicator when auto-save is in progress
